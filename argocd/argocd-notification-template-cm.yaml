apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  context: |
    argocdUrl: "https://localhost:8080"
    # Use el ingres del controller de argocd para pruebas en AWS
    #     argocdUrl: "https://internal-k8s-argocd-argocd-8efea739a6-1432857483.us-east-1.elb.amazonaws.com"


 # Servicio de notificaciones en teams
  service.teams: |
    recipientUrls:
      GitOps: $teams-webhook-url
      # para mas aplicaciones repita GitOps1, GitOps2, ... y agregue a las aplicaciones las anotaciones correspondientes

  # Trigger para OutOfSync
  trigger.on-outofsync: |
    - when: app.status.sync.status == 'OutOfSync'
      send: [app-outofsync-teams]

  # Trigger para vuelta a sincronización
  trigger.on-sync-succeeded: |
    - when: app.status.sync.status == 'Synced'
      send: [app-sync-succeeded]

  # Trigger para estado desconocido
  trigger.on-sync-status-unknown: |
    - when: app.status.sync.status == 'Unknown'
      send: [app-sync-status-unknown-teams]

  # Template para estado sincronizado
  template.app-sync-succeeded: |
    teams:
      themeColor: "#00a000"
      sections: |
        [{
          "facts": [
            {
              "name": "Estado de sincronización: ",
              "value": "{{.app.status.sync.status}}"
            },
            {
              "name": "Repositorio: ",
              "value": "{{.app.spec.source.repoURL}}"
            }
          ]
        }]
      potentialAction: |-
        [{
          "@type":"OpenUri",
          "name":"Operation Details",
          "targets":[{
            "os":"default",
            "uri":"{{.context.argocdUrl}}/applications/{{.app.metadata.name}}?operation=true"
          }]
        }]
      title: La aplicacion "{{.app.metadata.name}}" ha sido sincronizada exitosamente!
      text: Aplicación {{.app.metadata.name}} sincronizada a las {{.app.status.operationState.finishedAt}} horas.
      summary: "{{.app.metadata.name}} exitosamente sincronizada"

  # Template para alertas de desincronización
  template.app-outofsync-teams: |
    teams:
      themeColor: "#ff0000"
      sections: |
        [{
          "facts": [
            {
              "name": "Estado de sincronización: ",
              "value": "{{.app.status.sync.status}}"
            },
            {
              "name": "Repositorio: ",
              "value": "{{.app.spec.source.repoURL}}"
            }
          ]
        }]
      potentialAction: |-
        [{
          "@type":"OpenUri",
          "name":"Operation Details",
          "targets":[{
            "os":"default",
            "uri":"{{.context.argocdUrl}}/applications/{{.app.metadata.name}}?operation=true"
          }]
        }]
      title: La aplicación "{{.app.metadata.name}}" ha perdido el estado de sincronización!
      text: Aplicación {{.app.metadata.name}} dessincronizada a las {{.app.status.operationState.finishedAt}} horas.
      summary: "{{.app.metadata.name}} desincronizada!"


  